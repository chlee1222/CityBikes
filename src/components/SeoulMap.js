import React, { useEffect, useState, useRef } from "react";
import { Map, Circle, Polyline, Polygon, Marker, MapContainer, TileLayer, useMapEvents, useMap } from "react-leaflet";
import data from "./map-provider.js";
import "../styles/mappage.css";
import bikeData from '../data/bikeusage.csv'
import yeoido from '../data/yeoido.csv'
import magok from '../data/magok.csv'
import jamshil from '../data/jamshil.csv'
import Papa from 'papaparse';
import L, { map } from "leaflet"; 
import { render } from "@testing-library/react";
import styled from "styled-components";


const seoulpolyline = [
    [37.60748125599144, 126.80276847536804],
    [37.57599066488516, 126.85034680326048],
    [37.579095963120544, 126.87721456489383],
    [37.593289962930875, 126.88337176026816],
    [37.59062879413394, 126.89848487618691],
    [37.64472051947123, 126.91079926693553],
    [37.6572557954749, 126.94787010136538],
    [37.63102044949363, 126.97449482746613],
    [37.631957585684646, 126.98987800254653],
    [37.65397688397665, 126.98573637848645],
    [37.69846404353521, 127.00585283820696],
    [37.691441528616906, 127.03425254604772],
    [37.69425061439846, 127.04371911532799],
    [37.688632336419516, 127.05614398750835],
    [37.69425061439846, 127.06738553852864],
    [37.688632336419516, 127.09282694346933],
    [37.65866099893405, 127.08809365882921],
    [37.644139280733775, 127.09696856752946],
    [37.64554473240575, 127.10821011854975],
    [37.63476892335202, 127.11235174260986],
    [37.62961472304939, 127.10406849448965],
    [37.62071117146298, 127.1058434762297],
    [37.62024253394316, 127.11945166957007],
    [37.59399411851018, 127.11649336666999],
    [37.57430172880707, 127.09992687042953],
    [37.55648031648059, 127.1022935127496],
    [37.580866437507346, 127.17565942467158],
    [37.54897528847463, 127.18216769105176],
    [37.544753378103884, 127.1614595707512],
    [37.514724009015104, 127.14075145045064],
    [37.50299050333655, 127.14311809277069],
    [37.50205174320637, 127.15909292843115],
    [37.48843839497127, 127.16205123133123],
    [37.473413889698186, 127.13779314755057],
    [37.47623121455301, 127.12595993595023],
    [37.460264969534094, 127.11471838492992],
    [37.457916704719565, 127.09341860404935],
    [37.44194654847103, 127.08276871360906],
    [37.44194654847103, 127.07093550200874],
    [37.429731775666646, 127.0656105567886],
    [37.42738255235522, 127.04312745474799],
    [37.43818836916843, 127.03484420662777],
    [37.4663701129355, 127.03129424314766],
    [37.457916704719565, 127.02596929792752],
    [37.45697737814636, 127.00940280168706],
    [37.46824851830401, 127.00052789298682],
    [37.4588560194943, 126.97922811210626],
    [37.44617427457469, 126.97626980920619],
    [37.440067482412665, 126.94432013788528],
    [37.451810871101145, 126.93130360512497],
    [37.43349037962513, 126.90527053960426],
    [37.49641893455884, 126.86917924422326],
    [37.47670075837015, 126.84432949986258],
    [37.477639837154015, 126.81652145260182],
    [37.49031624570613, 126.82362137956201],
    [37.497357765507495, 126.81356314970175],
    [37.49641893455884, 126.81297148912172],
    [37.5292709944069, 126.82776300362214],
    [37.54146950472473, 126.8194797555019],
    [37.544753378103884, 126.80172993810142],
    [37.53724716927116, 126.79581333230126],
    [37.54569160107287, 126.79463001114124],
    [37.54897528847463, 126.77096358794059],
    [37.55648031648059, 126.76445532156043],
    [37.568205409650794, 126.77688019374075],
    [37.577115246262586, 126.7934466899812],
    [37.59305650379388, 126.80172993810142],
    [37.59680689177806, 126.79699665346129],
    [37.60748125599144, 126.80276847536804]
];

const magokpolyline = [
    [37.585424982338566, 126.81747209371373],
    [37.57701709315268, 126.83869101981378],
    [37.573464178560215, 126.84466818209548],
    [37.55474936451124, 126.83794387452855],
    [37.54740429237256, 126.83734615830039],
    [37.546574964558644, 126.81612723220034],
    [37.55202466414182, 126.81582837408625],
    [37.582227727914805, 126.81717323559964],
    [37.585424982338566, 126.81747209371373]
];

const yeoidoline = [
    [37.5359741223687, 126.91147344859169],
    [37.533913448137774, 126.9228208411895],
    [37.530547557774184, 126.9313097303085],
    [37.52381532135286, 126.93979861942749],
    [37.517700825112726, 126.94551562638517],
    [37.515502232086305, 126.9326090500716],
    [37.51522740340353, 126.92723852838408],
    [37.518456576505216, 126.91762356213707],
    [37.520448975304674, 126.91528478656346],
    [37.52656324633855, 126.91147344859169],
    [37.53288308966957, 126.9093945369707],
    [37.5359741223687, 126.91147344859169]
]

const jamshilline = [
    [37.5201888223951, 127.0683884100897],
    [37.51858245372933, 127.07996160577271],
    [37.51777925642818, 127.08632686339836],
    [37.52053303975281, 127.09529609005267],
    [37.52328672144707, 127.10238467240849],
    [37.51743502636687, 127.11308987841527],
    [37.51422213588827, 127.12032312571712],
    [37.504008815440635, 127.11439186292958],
    [37.50159872707703, 127.11019657949451],
    [37.4975817402563, 127.09630874467491],
    [37.502631631616254, 127.07475366771534],
    [37.504812160939984, 127.07012438944216],
    [37.5201888223951, 127.0683884100897]
];

const riverline = [
    [37.61622694657823, 126.79788549465371],
    [37.596103535761756, 126.82101500864869],
    [37.54241449651922, 126.91539168628883],
    [37.5422507508153, 126.93170625860337],
    [37.534226792303954, 126.94347752911865],
    [37.528167312720086, 126.95235761038457],
    [37.52210734086347, 126.95400971852706],
    [37.51506405241748, 126.9820955569495],
    [37.5304601463808, 127.01121396797042],
    [37.543233216716395, 127.02525688718164],
    [37.52767598169627, 127.0841132397581],
    [37.545104732840905, 127.1077750126676],
    [37.55816974608054, 127.11361149916299],
    [37.56606208168059, 127.13318089505925],
    [37.54279385323629, 127.11683572232776],
    [37.53459710199066, 127.10978247896557],
    [37.52092631803237, 127.09418614205293],
    [37.51832207513039, 127.08433582400285],
    [37.520438029411714, 127.06648212253707],
    [37.52792477043955, 127.0547848698526],
    [37.534759834220125, 127.02790170462065],
    [37.512462196174525, 126.99794032055165],
    [37.50790419452152, 126.99014215209533],
    [37.50578788485733, 126.97762403957334],
    [37.51474109262419, 126.95669211371691],
    [37.51832207502281, 126.94581572086993],
    [37.53117964077275, 126.9306298101398],
    [37.536061680126224, 126.9121604637959],
    [37.53508529782255, 126.90826137956773],
    [37.55168205831798, 126.88425122932065],
    [37.55428513647689, 126.87624784590496],
    [37.58209985577091, 126.82802232767463],
    [37.60632760394948, 126.79518793224412],
    [37.607303052736135, 126.78862105354408],
    [37.61622694657823, 126.79788549465371]
];

const yeoidoNature = [
    [
        [37.523274610097864, 126.91642355573632],
        [37.52181086226396, 126.91731452105762],
        [37.529028374972086, 126.92889707023438],
        [37.52988635451703, 126.927242420352],
        [37.523274610097864, 126.91642355573632]
    ],
    [
        [37.53124900762741, 126.90999587734701],
        [37.52625249118321, 126.9117778079896],
        [37.51958994864243, 126.91629627497613],
        [37.515551754514256, 126.92762426263256],
        [37.51812612852128, 126.94410712107644],
        [37.52044803674182, 126.94334343651533],
        [37.530542449862935, 126.93169724695845],
        [37.53377237357542, 126.92285123412564],
        [37.53563960941228, 126.91082320228821],
        [37.53457983264756, 126.90955039468635],
        [37.53346957416944, 126.90980495620671],
        [37.533368640760926, 126.9109504830484],
        [37.534176104204285, 126.91228693103031],
        [37.53266210307643, 126.92164206690389],
        [37.52943213128141, 126.92927891251495],
        [37.52059946302908, 126.94111602321213],
        [37.51822708255503, 126.94067054055148],
        [37.51777278832768, 126.94009777713065],
        [37.51676323569814, 126.92813338567329],
        [37.5209023146817, 126.91693267877706],
        [37.52670673378097, 126.91266877331086],
        [37.53140041199185, 126.91101412342849],
        [37.53124900762741, 126.90999587734701],   
    ]
];

const magokNature = [
    [
        [37.57695915538299, 126.83776404048501],
        [37.57574865210176, 126.83661851364336],
        [37.57247010689773, 126.83700035592392],
        [37.5707046766186, 126.83763675972484],
        [37.56772857084593, 126.83451838110032],
        [37.56389476782552, 126.83375469653922],
        [37.56460100952325, 126.82567236826749],
        [37.56782945773456, 126.83108180057533],
        [37.57247010689773, 126.83178184475636],
        [37.573609218837326, 126.82055306880015],
        [37.57504036990595, 126.82060466095133],
        [37.57843413249032, 126.81895371211401],
        [37.57961986849605, 126.81983077868382],
        [37.57953809420534, 126.81854097490466],
        [37.5788430091081, 126.81797346124185],
        [37.577779925231624, 126.81781868478835],
        [37.57782081335369, 126.81699321036969],
        [37.58235925533362, 126.81709639467202],
        [37.58317696321311, 126.82065625310248],
        [37.57695915538299, 126.83776404048501],
    ]
];

const jamshilNature = [
    [
        [37.509774120908105, 127.09765358135607],
        [37.506534822909614, 127.09752983918595],
        [37.50676386880043, 127.09963345607815],
        [37.50879253029827, 127.10375819508255],
        [37.5119662933307, 127.10792418147697],
        [37.51350404750148, 127.10714048106614],
        [37.51314415042906, 127.10590305936482],
        [37.514551010935094, 127.1050368641739],
        [37.5132095863895, 127.10054089865915],
        [37.5110828883084, 127.10210829948079],
        [37.50993771808812, 127.09934472434789],
        [37.509774120908105, 127.09765358135607]
    ],
    [
        [37.51592512815249, 127.1001284247587],
        [37.516448594722895, 127.09983969302839],
        [37.517102922772295, 127.10136584646],
        [37.51638316160241, 127.10173707297041],
        [37.51592512815249, 127.1001284247587]
    ],
    [
        [37.5040479936219, 127.10157208305178],
        [37.5006121064833, 127.10165457783185],
        [37.50093934064202, 127.10293324692323],
        [37.50388438353403, 127.10301574170332],
        [37.50434249087655, 127.10276825736304],
        [37.5040479936219, 127.10157208305178]
    ],
    [
        [37.51065754137411, 127.07389508380155],
        [37.50954508420739, 127.07422506292191],
        [37.50964324285962, 127.07558622679333],
        [37.50925060747622, 127.07624618503404],
        [37.50928332717038, 127.07748360673534],
        [37.50970868188937, 127.07785483324572],
        [37.5097741208618, 127.07855603887648],
        [37.5113773577646, 127.07806107019596],
        [37.51065754137411, 127.07389508380155],
    ]
];

const yeoidoStreet = [
    [37.52140987648335, 126.91706192055828],
    [37.5269031752952, 126.91351141670117],
    [37.53267301155349, 126.91129962741311],
    [37.533734612807024, 126.9119980871883],
    [37.53354998758754, 126.91531577112036],
    [37.53193449742116, 126.92189293400321],
    [37.5269031752952, 126.91351141670117],
    [37.53193449742116, 126.92189293400321],
    [37.52842645542868, 126.92445395317883],
    [37.53008818009715, 126.9272477922795],
    [37.52898036776484, 126.9295177865488],
    [37.52140987648335, 126.91706192055828],
    [37.51947096856663, 126.92061242441541],
    [37.52671853316527, 126.93254444557454],
    [37.51947096856663, 126.92061242441541],
    [37.517947505572124, 126.92422113325375],
    [37.52473360140472, 126.93516366973141],
    [37.517947505572124, 126.92422113325375],
    [37.51693184629589, 126.92870291681109],
    [37.524087333155535, 126.92171831905942],
    [37.52676469374059, 126.92608369265423],
    [37.51743967766199, 126.93516366973141],
    [37.51702417952862, 126.92864471182985],        
];
const magokStreet = [
    [37.54859526363215, 126.82016493767156],
    [37.54913895881127, 126.82270225631187],
    [37.552292312642834, 126.82565103202896],
    [37.55370584174196, 126.82626821764416], // point
    [37.55376020771036, 126.82462238933695],
    [37.55158553803954, 126.82181076597877],
    [37.54903022009272, 126.82496527023427],
    [37.55131369986898, 126.82763974123351],
    [37.55354274359879, 126.8282569268487],
    [37.55370584174196, 126.82626821764416],
    [37.55974022218248, 126.82681682710252],
    [37.566698180246206, 126.82784546979451],
    [37.56756787931096, 126.81659897636189],
    [37.563056205124994, 126.81653040018239],
    [37.56071872430196, 126.83909196322716],
    [37.563056205124994, 126.81653040018239],
    [37.56066436341024, 126.81653040018239],
    [37.55974022218248, 126.82681682710252],
    [37.55865298253354, 126.83833762525303],
    [37.55974022218248, 126.82681682710252],
    [37.566698180246206, 126.82784546979451],
    [37.57273150836975, 126.8287369601276],
    [37.573003268403575, 126.82585676058996],
    [37.557565727019785, 126.82331944194966],
    [37.555228073943766, 126.8203020900531],
    [37.55555426249627, 126.81989063297631],
    [37.556804638720685, 126.81982205679684],
    [37.56332800046109, 126.82085069948886],
    [37.56582847102722, 126.81899914264324],
    [37.56735045549674, 126.81913629500217],
];

const jamshilStreet = [
    [
        [37.502009305716484, 127.11005974778531],
        [37.51903611752555, 127.09568190936191],
        [37.51704829907299, 127.09059791191116],
        [37.516423545194286, 127.08436822489408],
        [37.516707524878456, 127.07713605950639],
        [37.5067107895398, 127.07949904423702],
        [37.504154591142445, 127.07534591955894],
        [37.50387056369555, 127.07377059640521],
        [37.50568832068389, 127.07169403406614],
        [37.5105733232778, 127.07069155569559],
        [37.50568832068389, 127.07169403406614],
        [37.50387056369555, 127.07377059640521],
        [37.504154591142445, 127.07534591955894],
        [37.5067107895398, 127.07949904423702],
        [37.50443861750881, 127.08794850478895],
        [37.50245041025298, 127.09697081012406],
        [37.505229592310016, 127.10717718874793],
        [37.507962438551154, 127.11064973011689],
        [37.51032353714221, 127.11224820154072],
        [37.516366530220665, 127.11591640623536],
        [37.517634745525164, 127.11285407854216],
        [37.51230379710584, 127.09626872855785],
        [37.51152991809303, 127.08849095755572],
        [37.51183087198717, 127.0782741649279],
        [37.5105733232778, 127.07069155569559],
    ],
    [
        [37.507553577550716, 127.09066069504442],
        [37.50819224289849, 127.08792333831816],
        [37.509693084957085, 127.08627287323318],
        [37.511640941353605, 127.08554827880566],
        [37.51646246557645, 127.0843808766724],
        [37.511640941353605, 127.08554827880566],
        [37.509693084957085, 127.08627287323318],
        [37.50819224289849, 127.08792333831816],
        [37.507553577550716, 127.09066069504442],
        [37.50113468740442, 127.08514572634591],
        [37.49712947796643, 127.09647588044669],
        [37.51000549358985, 127.09754361668523],
        [37.510308649733794, 127.09310086794267],
        [37.507553577550716, 127.09066069504442],
        [37.50644331667044, 127.09897676144092],
        [37.50792126176986, 127.10279848078939],
        [37.511975986516596, 127.10810111638538],
        [37.51375696421062, 127.10728900102383],
        [37.51011917728813, 127.09921561890019],
        [37.51000549358985, 127.09754361668523],
        [37.51011917728813, 127.09921561890019],
        [37.51375696421062, 127.10728900102383],
        [37.511975986516596, 127.10810111638538],
        [37.51038443848402, 127.11211392193512],
    ]
];



export const SeoulMap = () => {
    useEffect(()=>{
        parseStationFile(bikeData);
        parseYeoidoFile(yeoido)
        parseMagokFile(magok)
        parseJamshilFile(jamshil)
    }, [])

    const [parsedCsvData, setParsedCsvData] = useState([]);
    const [yeoidoData, setYeoidoData] = useState([]);
    const [magokData, setMagokData] = useState([]);
    const [jamshilData, setJamshilData] = useState([]);
    const [center, setCenter] = useState({ lat: 37.5516591, lng: 126.9939338 });
    const [zoom, setZoom] = useState(11.5);
    const mapRef = useRef();
    const [position, setPosition] = useState(null)
    const [map, setMap] = useState(null);

    const [pathvisible, setPathVisible] = useState(false);
    const [stationvisible, setStationVisible] = useState(false);
    const [naturevisible, setNatureVisible] = useState(false);
    const [streetvisible, setStreetVisible] = useState(false);
    const [areaVisible, setAreaVisible] = useState(false);


    const Button = styled.button`
    color: black;
    background-color: white;
    font-size: 10px;
    padding: 6px 10px;
    border-radius: 5px;
    margin: 7px 7px;
    cursor: pointer;
    border: white;
    `;




    // Parse CSV File of Bike Stations
    const parseStationFile = csvFile => {
        Papa.parse(csvFile, {
          download: true,
          complete: results => {
            setParsedCsvData(results.data)
          },
        });
      };
    
    //dictionary of key: value => bikestation: [latitude, longitude]
    const dictionary = {};

    parsedCsvData.forEach((station) => {
        dictionary[station[3]] = [station[5], station[6]]
      })


    // Parse CSV File of Bike Paths
    const parseYeoidoFile = csvFile => {
        Papa.parse(csvFile, {
          download: true,
          complete: results => {
            setYeoidoData(results.data)
          },
        });
      };
      const parseMagokFile = csvFile => {
        Papa.parse(csvFile, {
          download: true,
          complete: results => {
            setMagokData(results.data)
          },
        });
      };
      const parseJamshilFile = csvFile => {
        Papa.parse(csvFile, {
          download: true,
          complete: results => {
            setJamshilData(results.data)
          },
        });
      };

    // console.log(pathData[0])

    // 0: Location
    // 1: Date
    // 2: Count
    // 3: UniqueKey
    // 4: Name
    // 5: Latitude
    // 6: Longitude
    // console.log(parsedCsvData[0][1])


    function Yeouido() {
        map.flyTo([37.52579452316378, 126.92669177924313], 13);
        return null;
    }

    function Magok() {
        map.flyTo([37.5604813998787, 126.82872908857044], 13);
        return null;
    }

    function Jamshil() {
        map.flyTo([37.51162468606429, 127.10348133377589], 13);
        return null;
    }

    function Seoul() {
        map.flyTo(center, zoom);
        return null;
    }

    

    return (
        <div className = "container">
            
            <MapContainer 
                className = "leaflet-container" 
                center={center} 
                zoom={zoom} 
                whenCreated={setMap}
            >
                <TileLayer
                    url={data.maptiler.url}
                    attribution={data.maptiler.attribution}
                >
                </TileLayer>
                {parsedCsvData.map(station => (
                    <div>
                        { stationvisible ? 
                            <div>
                                <Circle 
                                    key = {station[3]}
                                    center = {[station[5], station[6]]}
                                    radius = {station[2]/12}
                                    color = 'hazel'
                                    // fillColor = '#f03'
                                    // fillOpacity = '0.2'
                                />
                            </div>
                            : null
                        }
                    </div>
                ))}
                <Polyline positions = {seoulpolyline} color = 'purple'/>
                <div>
                        { areaVisible ? 
                            <div>
                                <Polyline positions = {magokpolyline} color = 'red'/>
                                <Polyline positions = {yeoidoline} color = 'orange'/>
                                <Polyline positions = {jamshilline} color = 'violet'/>
                            </div>
                            : null
                        }
                    </div>
                <div>
                    <div>
                        {
                            pathvisible ? yeoidoData.map(path =>(
                                <Polyline positions = {[dictionary[path[0]], dictionary[path[2]]]} color = 'orange' weight = '1'/>
                            ))
                            : null
                        }
                    </div>
                    <div>
                        {
                            pathvisible ? jamshilData.map((path2, index) =>{
                                return dictionary[path2[2]] && (
                                <Polyline positions = {[dictionary[path2[0]], dictionary[path2[2]]]} color = 'violet' weight = '1'/>
                                )
                                })
                            
                            : null
                        }
                    </div>
                    <div>
                        {
                            pathvisible ? magokData.map((path3, index) =>{
                                return dictionary[path3[2]] && (
                                <Polyline positions = {[dictionary[path3[0]], dictionary[path3[2]]]} color = 'red' weight = '1'/>
                                )
                                })
                            
                            : null
                        }
                    </div>
                </div>
                <div>
                    <div>
                        {
                            naturevisible ? yeoidoNature.map( shape => {
                                return(
                                    <div>
                                        <Polygon positions = {shape} color = 'green' weight = '3'/>
                                        <Polygon positions = {riverline} color = 'blue' weight = '5'/>
                                    </div>
                                )
                            })

                            : null
                        }
                    </div>
                    <div>
                        {
                            naturevisible ? magokNature.map( shape => {
                                return(
                                    <div>
                                        <Polygon positions = {shape} color = 'green' weight = '3'/>
                                    </div>
                                )
                            })
                            : null
                        }   
                    </div>
                    <div>
                        {
                            naturevisible ? jamshilNature.map( shape => {
                                return(
                                    <div>
                                        <Polygon positions = {shape} color = 'green' weight = '3'/>
                                    </div>
                                )
                            })

                            : null
                        }
                    </div>
                </div>
                <div>
                    <div>
                        {
                            streetvisible ? 
                                <div>
                                    <Polyline positions = {yeoidoStreet} color = 'brown' weight = '2'/>
                                    <Polyline positions = {magokStreet} color = 'brown' weight = '2'/>
                                </div>
                            : null
                        }
                    </div>
                    <div>
                        {
                            streetvisible ? jamshilStreet.map(street =>(
                                <Polyline positions = {street} color = 'brown' weight = '2'/>
                            ))
                            : null
                        }
                    </div>
                </div>
                
            </MapContainer>

            


            <div className = 'buttonwrap'>
                <div id = 'column'>
                    <div>
                        <Button style = {{border: '1px solid black'}}onClick = {() => {setStationVisible(!stationvisible);}}> SeeStations </Button>
                        <Button style = {{border: '1px solid black'}}onClick = {() => {setAreaVisible(!areaVisible);}}> SeeArea </Button>
                    </div>
                    <div>
                        <Button style = {{color: 'orange'}} onClick = {() => { Yeouido();}}> Yeouido </Button>
                        <Button style = {{color: 'red'}} onClick = {() => { Magok();}}> Magok </Button>
                        <Button style = {{color: 'violet'}} onClick = {() => { Jamshil();}}> Jamshil </Button>
                        <Button style = {{color: 'purple'}} onClick = {() => { Seoul();}}> Seoul </Button>
                    </div>
                    <div>
                        <Button style={{ backgroundColor: 'green', color: 'white'}} onClick = {() => { setNatureVisible(!naturevisible);}}> SeeNature </Button>
                        <Button style={{ backgroundColor: 'brown', color: 'white'}} onClick = {() => { setStreetVisible(!streetvisible);}}> SeeBikeStreet </Button>
                        <Button style={{ backgroundColor: 'black', color: 'white'}} onClick = {() => { setPathVisible(!pathvisible);}}> SeeBikePath </Button>
                    </div>
                </div>
            </div>

        </div>
  );
};
